// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// プレイヤー
model Player {
  id        String   @id @default(cuid()) // DB管理用のID
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  memberId      Int     @unique @map("member_id") // お店で割り振る会員連番
  webCoinGameId String? @unique @map("web_coin_game_id") // WebCoinのゲームID
  name          String

  visitations Visit[]
  storeCoin   StoreCoin?

  @@map("players")
}

// 来店（1日1プレイヤー1レコード）
model Visit {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  playerId       String @map("player_id")
  entranceFee    Int?   @map("entrance_fee")
  foodAmount     Int?   @map("food_amount")
  discountAmount Int?   @map("discount_amount")

  player            Player            @relation(fields: [playerId], references: [id])
  tournamentEntries TournamentEntry[]
  ringGameEntry     RingGameEntry?
  settlements       Settlement[]

  @@map("visits")
}

// トーナメント定義（日付ごと）
model Tournament {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name String

  // 開始時刻
  startAt       DateTime @map("start_at")
  // 参加登録締め切り時刻
  entryClosesAt DateTime @map("entry_closes_at")

  entries          TournamentEntry[]
  tournamentPrizes TournamentPrize[]

  @@map("tournaments")
}

model TournamentPrize {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tournamentId String
  rank         Int // 順位
  amount       Int // 賞金

  tournament Tournament @relation(fields: [tournamentId], references: [id])

  @@map("tournament_prizes")
}

enum TournamentEntrySource {
  BUY_IN // 参加時点で支払い発生
  FREE // 無料参加
  SATELLITE // サテライト
}

// トナメ参加
// re-entryする際は、新規にレコードを作成することで対応する
model TournamentEntry {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  visitId      String @map("visit_id")
  tournamentId String @map("tournament_id")

  entrySource TournamentEntrySource @map("entry_source")

  finalRank   Int? @map("final_rank") // 特に入賞してない場合は何も書かなくていい
  bountyCount Int? @map("bounty_count") // そのエントリー中に飛ばした人数

  visit      Visit                 @relation(fields: [visitId], references: [id])
  tournament Tournament            @relation(fields: [tournamentId], references: [id])
  chipEvents TournamentChipEvent[]

  @@map("tournament_entries")
}

// ENTRY / ADD_CHIP
enum TournamentChipEventType {
  ENTRY // 初期参加
  ADD_CHIP // エントリー中に追加でチップを獲得
}

model TournamentChipEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tournamentEntryId String                  @map("tournament_entry_id")
  eventType         TournamentChipEventType @map("event_type")
  chipAmount        Int                     @map("chip_amount") // 獲得したチップ
  paymentAmount     Int                     @map("payment_amount") // 実際に払う必要があるお金

  tournamentEntry TournamentEntry @relation(fields: [tournamentEntryId], references: [id])

  @@map("tournament_chip_events")
}

// リングゲーム参加
model RingGameEntry {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  visitId String @unique @map("visit_id")

  visit      Visit               @relation(fields: [visitId], references: [id])
  chipEvents RingGameChipEvent[]

  @@map("ring_game_entries")
}

// BUY_IN / CASH_OUT
enum RingGameChipEventType {
  BUY_IN
  CASH_OUT
}

// リングゲームのチップの動きを記録する
model RingGameChipEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  ringGameEntryId String                @map("ring_game_entry_id")
  eventType       RingGameChipEventType @map("event_type")
  chipAmount      Int                   @map("chip_amount")

  ringGameEntry RingGameEntry @relation(fields: [ringGameEntryId], references: [id])

  @@map("ring_game_chip_events")
}

// 来店ごとの最終的な収支
model Settlement {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  visitId     String @map("visit_id")
  totalAmount Int    @map("total_amount")

  visit Visit @relation(fields: [visitId], references: [id])

  @@map("settlements")
}

// 店内コイン残高
model StoreCoin {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  playerId String @unique @map("player_id")
  balance  Int

  player Player @relation(fields: [playerId], references: [id])

  @@map("store_coins")
}
