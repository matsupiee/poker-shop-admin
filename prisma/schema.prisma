// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum StaffRole {
  ADMIN
  MANAGER
  MEMBER
}

model Staff {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name          String
  email         String  @unique
  emailVerified Boolean @map("email_verified")
  image         String?

  role StaffRole @default(MEMBER)

  staffSessions        StaffSession[]
  staffAccounts        StaffAccount[]
  ringGameDealerShifts RingGameDealerShift[]

  @@map("staff")
}

// ログインセッションを管理
// 1ログイン=1レコード
model StaffSession {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  staffId String @map("staff_id")

  token     String
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")

  staff Staff @relation(fields: [staffId], references: [id])

  @@map("staff_sessions")
}

// 1StaffUserが複数の認証方法を使えるようにする
model StaffAccount {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  staffId String @map("staff_id")

  // The ID of the account as provided by the SSO or equal to userId for credential accounts
  accountId  String @map("account_id")
  // The ID of the provider
  // メアド・パスワード→`credential` Googleアカウント→`google`
  providerId String @map("provider_id")

  // The access token of the account. Returned by the provider
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  accessTokenExpiresAt  DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  // The scope of the account. Returned by the provider
  scope                 String?
  // The ID token returned from the provider
  idToken               String?   @map("id_token")
  // The password of the account. Mainly used for email and password authentication
  password              String?   @map("password")

  staff Staff @relation(fields: [staffId], references: [id])

  @@map("staff_accounts")
}

// メール認証やパスワードリセット用のトークンを一時保存
model StaffVerification {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // The identifier for the verification request(メールアドレスなど)
  identifier String
  // The value to be verified(トークン、検証コードなど)
  value      String
  expiresAt  DateTime @map("expires_at")

  @@map("staff_verifications")
}

// プレイヤー
model Player {
  id        String   @id @default(cuid()) // DB管理用のID
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  memberId      String  @unique @map("member_id") // お店で割り振る会員連番
  webCoinGameId String? @unique @map("web_coin_game_id") // WebCoinのゲームID
  name          String

  webCoinBalance     Int @default(0) @map("web_coin_balance")
  inStoreChipBalance Int @default(0) @map("in_store_chip_balance")

  visits Visit[]

  // webコイン
  webCoinDeposits  WebCoinDeposit[]
  webCoinWithdraws WebCoinWithdraw[]

  // 店内リング専用チップ
  inStoreChipDeposits  InStoreChipDeposit[]
  inStoreChipWithdraws InStoreChipWithdraw[]

  @@map("players")
}

// 来店（1日1プレイヤー1レコード）
model Visit {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  playerId String @map("player_id")

  // 支払い関連の情報
  entranceFee Int? @map("entrance_fee")
  foodFee     Int? @map("food_fee")

  player             Player              @relation(fields: [playerId], references: [id])
  tournamentEntries  TournamentEntry[]
  webCoinRingEntry   WebCoinRingEntry?
  inStoreRingEntry   InStoreRingEntry?
  settlement         Settlement?
  webCoinDeposit     WebCoinDeposit?
  inStoreChipDeposit InStoreChipDeposit?

  @@map("visits")
}

// トーナメント定義（日付ごと）
model Tournament {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name String

  // 開始時刻
  startAt       DateTime @map("start_at")
  // 参加登録締め切り時刻
  entryClosesAt DateTime @map("entry_closes_at")

  entries                    TournamentEntry[]
  tournamentPrizes           TournamentPrize[]
  tournamentBounty           TournamentBounty?
  tournamentChipEventOptions TournamentChipEventOption[]

  @@map("tournaments")
}

model TournamentPrize {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tournamentId String
  rank         Int // 順位
  amount       Int // 賞金

  tournament Tournament @relation(fields: [tournamentId], references: [id])

  @@map("tournament_prizes")
}

// バウンティがあるトーナメントはこのテーブルを使って設定する
model TournamentBounty {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tournamentId String @unique @map("tournament_id")

  // バウンティチケット配布人数
  ticketCount Int @map("ticket_count")
  // バウンティ賞金総額
  totalAmount Int @map("total_amount")

  tournament Tournament @relation(fields: [tournamentId], references: [id])

  @@map("tournament_bounties")
}

// トナメ参加
// re-entryする際は、新規にレコードを作成することで対応する
model TournamentEntry {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  visitId      String @map("visit_id")
  tournamentId String @map("tournament_id")

  finalRank   Int? @map("final_rank") // 特に入賞してない場合は何も書かなくていい
  bountyCount Int? @map("bounty_count") // そのエントリー中に飛ばした人数
  prizeAmount Int? @map("prize_amount") // そのエントリーで獲得したprize

  visit                Visit                 @relation(fields: [visitId], references: [id])
  tournament           Tournament            @relation(fields: [tournamentId], references: [id])
  tournamentChipEvents TournamentChipEvent[]

  @@map("tournament_entries")
}

// ENTRY / ADD_CHIP
enum TournamentChipEventType {
  ENTRY // 初期参加
  ADD_CHIP // エントリー中に追加でチップを獲得
}

model TournamentChipEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tournamentEntryId String                  @map("tournament_entry_id")
  eventType         TournamentChipEventType @map("event_type")

  // チップ量
  chipAmount   Int @map("chip_amount")
  // 支払請求額
  chargeAmount Int @map("charge_amount")

  tournamentEntry TournamentEntry @relation(fields: [tournamentEntryId], references: [id])

  @@map("tournament_chip_events")
}

model TournamentChipEventOption {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tournamentId String @map("tournament_id")

  eventType TournamentChipEventType @map("event_type")

  name         String @map("name")
  chipAmount   Int    @map("chip_amount")
  chargeAmount Int    @map("charge_amount")

  tournament Tournament @relation(fields: [tournamentId], references: [id])

  @@map("tournament_chip_event_options")
}

model WebCoinRingEntry {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  visitId String @unique @map("visit_id")

  visit                 Visit                  @relation(fields: [visitId], references: [id])
  webCoinRingChipEvents WebCoinRingChipEvent[]

  @@map("web_coin_ring_entries")
}

enum WebCoinRingChipEventType {
  BUY_IN
  CASH_OUT
  GIFT // 早期来店などによるプレゼント
}

model WebCoinRingChipEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  webCoinRingEntryId String                   @map("web_coin_ring_entry_id")
  eventType          WebCoinRingChipEventType @map("event_type")
  chipAmount         Int                      @map("chip_amount")

  webCoinRingEntry WebCoinRingEntry @relation(fields: [webCoinRingEntryId], references: [id])

  @@map("web_coin_ring_chip_events")
}

model InStoreRingEntry {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  visitId String @unique @map("visit_id")

  visit                 Visit                  @relation(fields: [visitId], references: [id])
  inStoreRingChipEvents InStoreRingChipEvent[]

  @@map("in_store_ring_entries")
}

enum InStoreRingChipEventType {
  BUY_IN
  CASH_OUT
  GIFT // 早期来店などによるプレゼント
  WITHDRAW // 引き出し(webコインリングは最後に精算するので、引き出しの概念はない)
}

model InStoreRingChipEvent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  inStoreRingEntryId String                   @map("in_store_ring_entry_id")
  eventType          InStoreRingChipEventType @map("event_type")
  chipAmount         Int                      @map("chip_amount")

  inStoreRingEntry InStoreRingEntry @relation(fields: [inStoreRingEntryId], references: [id])

  // eventType=WITHDRAWの場合のみInStoreChipWithdrawとリレーションが貼られる
  inStoreChipWithdraw InStoreChipWithdraw?

  @@map("in_store_ring_chip_events")
}

// 店内リングだけ、BUY_INできる額は固定
model InStoreRingBuyInOption {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chipAmount   Int @map("chip_amount") // 例: 100
  chargeAmount Int @map("charge_amount") // 例: 3000円

  @@map("in_store_ring_buy_in_options")
}

enum RingGameType {
  WEB_COIN
  IN_STORE
}

model RingGameDesk {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  name                 String
  ringGameDealerShifts RingGameDealerShift[]

  @@map("ring_game_desks")
}

model RingGameDealerShift {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staffId String

  // 稼働時間
  startedAt DateTime  @map("started_at")
  endedAt   DateTime? @map("ended_at")

  ringGameDeskId String

  // webコインリングか店内リングか選択
  ringGameType RingGameType @map("ring_game_type")

  // 実績
  rakeChip   Int @default(0) @map("rake_chip")
  jpRakeChip Int @default(0) @map("jp_rake_chip")
  dealerChip Int @default(0) @map("dealer_chip")

  staff        Staff        @relation(fields: [staffId], references: [id])
  ringGameDesk RingGameDesk @relation(fields: [ringGameDeskId], references: [id])

  @@map("ring_game_dealer_shifts")
}

// 来店ごとの最終的な収支
model Settlement {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  visitId String @unique @map("visit_id")

  // 最終的な収支
  // 支払う場合はマイナス、支払う必要がない場合はプラス
  netAmount Int @map("net_amount")

  webCoinWithdrawId String? @unique @map("web_coin_withdraw_id")

  visit           Visit            @relation(fields: [visitId], references: [id])
  settlementItems SettlementItem[]
  webCoinWithdraw WebCoinWithdraw? @relation(fields: [webCoinWithdrawId], references: [id])

  @@map("settlements")
}

enum SettlementItemType {
  // トーナメント
  TOURNAMENT_TOTAL_CHARGE
  TOURNAMENT_TOTAL_PRIZE
  // webコイン リングゲーム
  WEB_COIN_RING_TOTAL_BUY_IN
  WEB_COIN_RING_TOTAL_CASH_OUT
  // 店内リング
  IN_STORE_CHIP_WITHDRAW_FEE
  IN_STORE_CHIP_BUY_IN_FEE
  // 消費税
  CONSUMPTION_TAX
  // webコイン 引き出し
  WEB_COIN_WITHDRAW
}

model SettlementItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  settlementId String @map("settlement_id")

  settlementItemType SettlementItemType @map("settlement_item_type")
  amount             Int

  settlement Settlement @relation(fields: [settlementId], references: [id])

  @@map("settlement_items")
}

model WebCoinDeposit {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  playerId      String  @map("player_id")
  depositAmount Int     @map("deposit_amount")
  visitId       String? @unique @map("visit_id")

  player                        Player                         @relation(fields: [playerId], references: [id])
  visit                         Visit?                         @relation(fields: [visitId], references: [id])
  webCoinDepositWithdrawAmounts WebCoinDepositWithdrawAmount[]

  @@map("web_coin_deposits")
}

model WebCoinDepositWithdrawAmount {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  webCoinDepositId  String @map("web_coin_deposit_id")
  webCoinWithdrawId String @map("web_coin_withdraw_id")

  amount Int

  webCoinDeposit  WebCoinDeposit  @relation(fields: [webCoinDepositId], references: [id])
  webCoinWithdraw WebCoinWithdraw @relation(fields: [webCoinWithdrawId], references: [id])

  @@map("web_coin_deposit_withdraw_amounts")
}

model WebCoinWithdraw {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  playerId String @map("player_id")

  withdrawAmount Int @map("withdraw_amount") // 引き出し額

  player                        Player                         @relation(fields: [playerId], references: [id])
  webCoinDepositWithdrawAmounts WebCoinDepositWithdrawAmount[]
  settlement                    Settlement?

  @@map("web_coin_withdraws")
}

model InStoreChipDeposit {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  playerId      String  @map("player_id")
  depositAmount Int     @map("deposit_amount")
  visitId       String? @unique @map("visit_id")

  player                            Player                             @relation(fields: [playerId], references: [id])
  visit                             Visit?                             @relation(fields: [visitId], references: [id])
  inStoreChipDepositWithdrawAmounts InStoreChipDepositWithdrawAmount[]

  @@map("in_store_chip_deposits")
}

model InStoreChipDepositWithdrawAmount {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  inStoreChipDepositId  String @map("in_store_chip_deposit_id")
  inStoreChipWithdrawId String @map("in_store_chip_withdraw_id")

  amount Int

  inStoreChipDeposit  InStoreChipDeposit  @relation(fields: [inStoreChipDepositId], references: [id])
  inStoreChipWithdraw InStoreChipWithdraw @relation(fields: [inStoreChipWithdrawId], references: [id])

  @@map("in_store_chip_deposit_withdraw_amounts")
}

model InStoreChipWithdraw {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  playerId               String  @map("player_id")
  inStoreRingChipEventId String? @unique @map("in_store_ring_chip_event_id")

  withdrawAmount Int @map("withdraw_amount") // 引き出し額

  player                            Player                             @relation(fields: [playerId], references: [id])
  inStoreRingChipEvent              InStoreRingChipEvent?              @relation(fields: [inStoreRingChipEventId], references: [id])
  inStoreChipDepositWithdrawAmounts InStoreChipDepositWithdrawAmount[]

  @@map("in_store_chip_withdraws")
}
